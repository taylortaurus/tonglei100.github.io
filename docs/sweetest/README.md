# Sweetest 文档

[更新日志](/sweetest/log)

[Web 版测试报告使用说明](/sweetest/report)

## 介绍

Sweetest 是一款小而美的自动化测试解决方案，同时支持 Web UI，Http 接口，DB 操作测试，Android/iOS App 测试，小程序测试，Windows GUI 测试，文件操作；由于开始只支持 Web UI 测试，名字取自 Selenium，Web UI，Excel，Element， Test 含义。
特点:

1. 简单快速，轻松上手
2. 无需编码能力
3. 在 Excel 中以文本编写测试用例
4. 维护成本低
5. 支持千、万级别的用例规模
6. 拥抱变化，支持敏捷

### 背景

目前，自动化测试基本上是以 Selenium/Appium 等库为接口来编写**测试代码**，但效果往往不是很好，普遍遇到如下问题：

1. 用例设计人员的编码能力不足，测试代码编写和维护成本高，效果差；
2. 测试代码量大，测试意图不直观，无法支撑千、万级别的用例规模；
3. 页面元素的定位非常繁琐，且页面结构经常变动，导致用例失效。

为了解决以上问题，使自动化测试更简单、可靠、容易落地，我们设计了此自动化测试框架，自动化测试用例和传统的手工测试用例一样在 Excel 中用文本编写。
同时我们的元素定位也设计的非常精巧，结合“变量定位法”，可以让页面自由的去变化，而我们的用例只做最小改动即可适用。

### 实现思路

1. Selenium 为底层接口；
2. 在 Excel 中用文本编写测试用例；
3. 元素定位表格化，且优先使用“变量定位法”；
4. 框架负责解析测试用例，执行用例，记录日志，输出测试结果。

### 方案

1. 开发语言：Python
2. 底层接口：Selenium
3. 用例工具：Excel

测试用例如下图：
![testcase](../_snapshot/testcase.png)

## 安装

### 环境要求

- 系统要求：Windows
- Python 版本：**3.6+**
- 浏览器：Chrome/IE/Firefox/Safari
- Chrome 驱动: [chromedriver](https://npm.taobao.org/mirrors/chromedriver) (需和 Chrome 版本匹配，并配置环境变量，[参考这里配置](https://segmentfault.com/a/1190000013940356))

### 安装 sweetest

```bash
pip install sweetest
```

### 升级 sweetest

```bash
pip install -U sweetest
```

## 快速体验

打开 cmd 命令窗口，切换到某个目录，如：D:\\Autotest

```bash
sweetest
cd sweetest_example
python start.py
```

![install](../_snapshot/install.png)

OK，如果一切顺利的话，sweetest 已经跑起来了

## 目录结构

![dir](../_snapshot/dir.png)

| 目录        | 说明                  |
| --------------------- | --------------------------------------------------- |
| data\\      | 测试数据目录                |
| \\Baidu-baidu.csv   | 测试数据文件，名称格式：project_name + '-' + sheet_name +".csv" |
| element\\     | 页面元素表目录               |
| \\Baidu-Elements.xlsx | 页面元素表，名称格式：project_name + "-Elements.xlsx"    |
| JUnit\\     | JUnit格式测试结果目录             |
| log\\       | 自动化测试运行日志目录               |
| report\\      | Excel 格式测试结果目录              |
| snapshot\\    | 错误截图目录                |
| testcase\\    | 测试用例目录                |
| \\Baidu-TestCase.xlsx | 测试用例，名称格式：project_name + "-TestCase.xlsx"     |
| start.py      | 启动脚本，`test = Autotest(project_name, sheet_name)`  |

备注：

1. 以上3处的 project_name 必须一致
2. data, JUnit, log, report, snapshot 目录可以不存在，程序启动后会自动判断并创建。

## 页面元素表

页面元素表的作用主要是把元素定位独立出来，一是方便维护定位信息，二是测试用例中用元素名称书写，可读性更高。

![elements](../_snapshot/elements.png)

| 字段  | 注释                 |
| ------- | ---------------------------------------------------- |
| page  | element 所在的页面，在所有页面都可用的 element 放在“通用”下面，如 title   |
| element | element 名称，在不同的 page 下面可以同名          |
| by  | Selenium 定位方式              |
| value | Selenium 定位的值              |
| custom  | 自定义字段，如 element 在 frame/iframe 中，则在此填写 frame id/name |
| 备注  | 注释作用                 |

## 元素定位

1. `id`, `link_text`, `partial_link_text`, `xpath`, `class_name`

如：

| page    | element | by   | value |
| ------- | ------- | ---- | ----- |
| 百度首页 | 搜索框  | `id` | kw    |

则自动化运行时会以 `find_element_by_id('kw')` 来定位

2. 带变量的定位方式

如示例中：

| page  | element     | by    | value              |
| ----- | ----------- | ----- | ------------------ |
| 搜索页 | `搜索结果#` | xpath | `//*[@id="#"]/h3/a` |

  写用例时，需要在 `搜索结果#` 后面带上变量，如： `搜索结果#1`

| 操作  | 页面   | 元素        |
| ----- | ----- | ----------- |
| 点击  | 搜索页 | `搜索结果#1` |

则自动化运行时会以 `find_element_by_xpath('//*[@id="1"]/h3/a')` 来定位

已定义好的常用变量定位方式：

- id#
- link#
- \*link#
- xpath#
- class#
- name#
- div#
- input#
- button#
- table#
- url#

如：`url#www.baidu.com`

当然，如果#后面的变量不够直观的话，不建议太多使用这几个变量方式。

3. 页面title

  页面的 title

4. 页面url

  页面的 url

5. 通用

一般来讲，导航栏在所有页面都存在，应该把导航栏放在 `通用` 下面，做成变量定位方式，如示例中的：

| page | element | by  | value           |
| ---- | ------- | ----- | ----------------------------------- |
| 通用 | 搜索页导航栏# | xpath | //\*[@class="s_tab"]//a[text()="#"] |

用例中的写法：

| 操作 | 页面 | 元素              |
| ---- | ---- | ----------------- |
| 点击 | 通用 | 搜索页导航栏#新闻 |

注意：链接必须放在 `通用` 下面

| page | element    | by  | value                    |
| ---- | ---------- | --- | ------------------------ |
| 通用  | 百度搜索链接 | url | https://www.baidu.com/   |


## 测试用例

![testcase](../_snapshot/testcase.png)

### 用例字段

必填字段：

- 用例编号
- 测试步骤
- 操作
- 页面
- 元素

### 前置条件

- `BASE`： 整个测试套件的基础，必须通过才会执行下一步，如：登录；如果有的话应该为第一个测试用例。
- `SETUP`：每个测试用例执行前需要执行的用例，只有 `SETUP` 执行成功才会执行该用例，如：返回首页。
- `MAIN`：一组用例的第一个用例，和 `SUB` 一起使用，一个 `MAIN` 后面可以带多个连续的 `SUB` 用例。此用例需要先执行 `SETUP` 用例。
- `SUB`：和 `MAIN` 一起使用，当前一个用例(`MAIN` or `SUB`)执行结果为通过时才会执行，否则测试结果置为 `Blocked`；且执行此用例前不会执行 `SETUP` 用例。
- `SKIP`: 该用例跳过 `SETUP` 执行。
- `SNIPPET`：用例片段，运行到此用例时不会立即执行，需要在其他用例中使用“执行”关键字调用此 `用例片段`，才会执行；配合 `执行` 关键字的变量赋值功能，可以实现用例复用。

注意事项：

- 一般必须有 `SETUP` 用例。当执行 `SETUP` 失败，会尝试执行一次 `BASE` -> `SETUP` 作为 `SETUP` 的执行结果。
- `BASE` 用例可以有 0 到多个，但作为 `SETUP` 中  `BASE` -> `SETUP` 的 `BASE` 只有最后一个 `BASE` 用例。
- `SETUP` 用例只能有 1 条，如果写了多条，只有最后一条起作用。

### 操作(关键字)

#### 1.  打开

  即 `get` 方法，打开一个链接。

  打开操作，一般要在测试数据中指定标签页名称，如：#tab_name=百度搜索窗口。

| 操作  | 页面  | 元素 | 测试数据    |
| --- | --- | ---- | ----------- |
| `打开`  | 通用  | 百度首页 | #tab_name=百度搜索窗口 |

  如果需要清理缓存再打开，则在测试数据中写上：`清理缓存=是`

| 操作  | 页面  | 元素 | 测试数据     |
| --- | --- | ---- | ------------------ |
| 打开  | 通用  | 百度首页 | #tab_name=百度搜索窗口，`清理缓存=是` |

> 注意：打开操作的页面必须是：`通用`，这也意味着在元素定义表中，链接必须定义在通用中。

支持自定义 cookie，见`自定义 cookie`章节

#### 2.  检查

取页面元素的值、属性和预期结果对比。

测试数据中如果没有写 `k=v` 的方式，则默认是取元素的 `text`。

- 检查 text：

| 操作  | 页面   | 元素 | 测试数据 |
| --- | ------ | ---- | ---- |
| `检查`  | 百度搜索页面 | 搜索按钮 | `百度一下` |

等价于

| 操作  | 页面   | 元素 | 测试数据  |
| --- | ------ | ---- | --------- |
| `检查`  | 百度搜索页面 | 搜索按钮 | `text=百度一下` |

- 检查属性：

| 操作  | 页面   | 元素  | 测试数据  |
| --- | ------ | --- | ------- |
| 检查  | 百度搜索页面 | 搜索框 | `name=wd` |

- `页面title` 和 `页面url` 直接在测试数据中写预期结果即可。

| 操作 | 页面         | 元素      | 测试数据            |
| ---- | ------------ | --------- | ------------------- |
| 检查 | 百度搜索页面 | `页面title` | 百度一下，你就知道 |

注意：

  1. 测试数据中，多个 `k=v` 用英文逗号(`,`)或双英文逗号(`,,`)分隔
  2. 在用英文逗号(`,`)分割时，如果 `v` 中有英文逗号(`,`)，要用反斜杠(`\`)转义
  3. 在用双英文逗号(`,,`)分割时，`v` 中的单英文逗号(`,`)的内容无需转义，例如：

| 操作  | 页面   | 元素  | 测试数据    |
| --- | ------ | ------- | ----------- |
| GET | Echo   | get请求  | `params={'foo1': 'bar1', 'foo2': 'bar2'},,cookies={'user': 'test'}` |

  4. 如果只有一个 `k=v`，也可以尾部加双英文逗号(`,,`)分割，如：

| 操作  | 页面   | 元素  | 测试数据    |
| --- | ------ | ------- | ----------- |
| GET | Echo   | get请求  | `params={'foo1': 'bar1', 'foo2': 'bar2'},,` |

> 在同一份用例中，英文逗号(`,`) 和双英文逗号(`,,`)可以混用，但一个单元格内只能使用一种格式。

#### 3.  输入

在输入框中输入文本:

| 操作  | 页面  | 元素  | 测试数据 |
| --- | ----- | --- | ---- |
| `输入`  | 百度搜索页 | 搜索框 | 搜狗 |

如果输入是具有联想下拉菜单时 可能需要逐字输入功能（模拟真实的键盘输入场景），应写为 `word=...`,如：

| 操作    | 页面    | 元素   | 测试数据 |
| ------- | ------  | ----- | ------- |
| `输入`  | 百度搜索页 | 搜索框 | word=搜狗 |

框架会先做 clear() 操作，以防止输入框中已有文本。
如果不想做 clear() 操作，需在测试数据中，加上：`清除文本=否`，如:

| 操作  | 页面  | 元素  | 测试数据  |
| --- | ----- | --- | --------- |
| 输入  | 百度搜索页 | 搜索框 | 搜狗，`清除文本=否` |

测试数据列为要输入的内容。

`按键操作`，如：回车键

| 操作 | 页面       | 元素   | 测试数据     |
| ---- | ---------- | ------ | ------------ |
| 输入 | 百度搜索页 | 搜索框 | `<Keys.ENTER>` |

`组合按键操作`，如：`ctrl+a`，如下：

| 操作  | 页面  | 元素  | 测试数据       |
| --- | ----- | --- | ------------------------ |
| 输入  | 百度搜索页 | 搜索框 | `<Keys.CONTROL\, 'a'>` |

这里的逗号前需要加反斜杠(`\`)来转义；但如果是双逗号(,,)分割，则不需要，如：

| 操作  | 页面  | 元素  | 测试数据       |
| --- | ----- | --- | ------------------------ |
| 输入  | 百度搜索页 | 搜索框 | `<Keys.CONTROL, 'a'>,,` |

`文本` + `按键操作`，如：`Sweetest` + `回车`

| 操作  | 页面  | 元素  | 测试数据       |
| --- | ----- | --- | ------------------------ |
| 输入  | 百度搜索页 | 搜索框 | `text=Sweetest, text1=<Keys.ENTER>` |

#### 4.  点击/右击/双击

点击按钮或者链接等(一切可点击操作的)元素，如：

| 操作  | 页面   | 元素 |
| --- | ------ | ---- |
| `点击`  | 百度搜索页面 | 搜索按钮 |

当无法正常点击到元素时，可以指定用 js 强制点击，只需要在测试数据里写上：`mode=js`

| 操作    | 页面    | 元素     |  测试数据  |
| ------  | ------ | -------- | ---------- |
| `点击`  | 百度    | 搜索按钮  | `mode=js` |

#### 5.  移动到

有些页面元素，当鼠标移动到上面时，会弹出下拉菜单等。此操作同关键字 `点击` 类似。

#### 6.  拖拽

把元素拖拽到另一个元素上

| 操作  | 页面   | 元素                |
| --- | ------ | ------------------- |
| `拖拽`  | 看板   | 测试任务 \| 已完成阶段 |

#### 7.  滑动

拖动元素在 x，y 方向上移动移动一段距离

| 操作  | 页面    | 元素   |  测试数据     |
| --- | -------- | ----- | ------------ |
| `滑动`  | 解锁界面 | 滑动条 |  x=500,y=100 |

#### 8.1  执行: 用例片段

即执行测试用例片段，支持在测试数据中给变量赋值，如我们有用例片段 `SNIPPET_001`，则测试用例 `BAIDU_002` 中，步骤1如下：

| 操作  | 页面 | 元素    | 测试数据    |
| --- | ---- | ----------- | ----------- |
| `执行`  | `用例片段` | `SNIPPET_001` | keywords=搜狗 |

把变量 `keyswords` 赋值为 `搜狗`，此步骤会执行用例片段 `SNIPPET_001`，其搜索的关键字为 `搜狗`。

**执行** 关键字支持循环次数，只需要在元素列中，`SNIPPET_ID*N`，如：

| 操作  | 页面    | 元素             | 测试数据 |
| ----- | ------- | --------------- | ------- |
| 执行  | 用例片段 | `SNIPPET_001*6` |         |

在循环执行过程中，如果用例片段执行失败，则直接退出。如果想某次循环失败后还继续执行，则只需要在N后加上一个 `*`，如：

| 操作  | 页面    | 元素              | 测试数据 |
| ----- | ------- | ---------------- | ------- |
| 执行  | 用例片段 | `SNIPPET_001*6*` |         |

把测试数据文件中的数据全部循环执行，则循环次数写为 `N`,即 `SNIPPET_ID*N`，如：

| 操作  | 页面    | 元素             | 测试数据 |
| ----- | ------- | --------------- | ------- |
| 执行  | 用例片段 | `SNIPPET_001*N` |         |

同时，循环执行还支持循环结束条件(`#break`)，值可取：`success` 或 `failure`，即当用例片段执行 `success`/`failure` 即跳出，达到结束条件跳出时，测试结果为成功。
`#break` 优先级高于循环次数，但是如果已经把循环次数执行完，还未触发 `#break`，循环也会结束，此时测试结果是失败。如下：

| 操作  | 页面 | 元素     | 测试数据  |
| --- | ---- | -------------- | --------- |
| 执行  | 用例片段 | SNIPPET_001*6 | `#break=success` |

#### 8.2  执行: 变量赋值

给变量赋值，在后续的测试数据中使用

| 操作   | 页面 | 元素       | 测试数据         |
| ------ | ---- | --------- | --------------- |
| `执行` | 通用 | `变量赋值`  | `keywords`=搜狗 |
| 输入   | 通用 | 搜索框      | `<keywords>`    |

#### 9.  脚本

即：执行 `js` 脚本，`js` 脚本写在元素列

| 操作  | 页面  | 元素           |
| --- | --- | ------------------------------ |
| 脚本  | 通用  | `window.alert('这是一个测试Alert弹窗');` |

注意：如果需要在 `frame` 中执行脚本，需要在元素定义表中定义元素，并填写 `custom`，如：

- 元素定义表：

| page | element | by  | value                 |  custom |
| ---- | ------- | --- | --------------------- |---------|
| 首页 | 点击链接  | js  | `$("a.xxx")[0].click()` | frame1  |

- 用例：

| 操作  | 页面  | 元素  |
| ---- | ---- | ----- |
| 脚本 | 首页 | 点击链接 |

#### 10.  对话框(`Alert`, `confirm`, `prompt`)

弹出对话框操作，支持如下几个操作：

- 确认
- 取消
- 关闭
- 输入

如：

| 操作  | 页面  | 元素  | 测试数据 |
| --- | --- | --- | ---- |
| 对话框 | 通用  | 确认  |  |

| 操作  | 页面  | 元素  | 测试数据    |
| --- | --- | --- | ----------- |
| 对话框 | 通用  | 输入  | hello world |

> 注：输入操作，默认自动点击确认按钮

#### 11.  \#检查

把检查结果反向。

#### 12. 上传文件

- 方式一：input 标签

如果`上传文件`是 input 标签，例如：
`<input type="file" name="file" />`
则可以直接通过 `输入` 关键字来实现上传文件

| 操作    | 页面       | 元素    | 测试数据                |
| ------- | --------- | ------- | ---------------------- |
| `输入`  | 个人信息   | 上传头像 | `D:\pig.png`      |

非 input 标签的，则需要方式二。

- 方式二：非 input 标签

此关键字仅支持 Windows，需要安装 `win32com`

```bash
pip install pypiwin32
```

测试用例写法如下：

| 操作  | 页面  | 元素  | 测试数据    |
| --- | --- | --- | ----------- |
| 上传文件 | 通用  | 文件  | `file=D:\doc\test.txt` |

备注：

- 测试数据中，`file=` 可以省略
- 不支持路径中包含中文
- 输入法默认设置为英文

#### 13. 导航: 前进/后退/刷新

| 操作 | 页面  | 元素  | 测试数据    |
| ---- | ---- |  ---- | ---------- |
| 导航 |  首页 | 后退  |            |
| 导航 |  首页 | 前进  |            |
| 导航 |  首页 | 刷新  |            |

#### 14. 滚动条

对于页面已加载的元素，如果该元素不在可视区域，则框架会自动尝试滚动到元素可见；但有以下2种情况不适用

1. 动态加载的元素(即尚未加载的元素)
2. 内嵌滚动条中被遮挡的元素

对应的，滚动条操作的对象可以是整个页面，也可以是有滚动条的内嵌窗口

- 整个页面格式如下表，元素为空，测试数据为滚动位移，默认值为竖轴(y)，也可以设置横轴(x)

| 操作  | 页面   | 元素  | 测试数据    |
| ----- | ----- | ----- | ---------- |
| 滚动条 |  首页 |       |  10000     |

测试数据也可以写：`y=1000` 或 `x=500` 或 `y=1000,x=500`

- 内嵌滚动条格式，测试数据如页面格式。

| 操作  | 页面   | 元素     | 测试数据    |
| ----- | ----- | -------- | ---------- |
| 滚动条 |  首页 | timeline |  10000     |

#### 15. 选择(下拉框)

支持按 index，value，visible_text 方式选择，如

| 操作  | 页面   | 元素   | 测试数据     |
| --- | ------  | ------ | ----------- |
| 选择  | 百度   | 下拉框 | index=0     |

需要多选时，按如下方式书写：

| 操作  | 页面   | 元素   | 测试数据     |
| --- | ------  | ------ | ----------- |
| 选择  | 百度   | 下拉框 | value0=广东,value1=江苏 |

支持混合方式多选：

| 操作  | 页面   | 元素   | 测试数据     |
| --- | ------  | ------ | ----------- |
| 选择  | 百度   | 下拉框 | index=0, value=江苏 |

visible_text 可以简写为 text：

| 操作  | 页面   | 元素   | 测试数据     |
| --- | ------  | ------ | ----------- |
| 选择  | 百度   | 下拉框 | text=江苏    |

#### 16. 取消选择(下拉框)

取消全部选择

| 操作     | 页面    | 元素   | 测试数据     |
| -------- | ------ | ------ | ----------- |
| 取消选择  | 百度   | 下拉框  | all=yes    |

取消选择的测试数据格式同选择关键字：

| 操作     | 页面    | 元素   | 测试数据     |
| -------- | ------ | ------ | ----------- |
| 取消选择  | 百度   | 下拉框  | index=0    |

### 测试数据

测试数据支持模糊匹配，如下：

| 操作  | 页面  | 元素 | 测试数据 |
| --- | --- | ---- | ---- |
| 检查  | 通用  | 页面标题 | `*知乎` |

则，页面标题中含有 `知乎` 即为通过。注意星号(`*`)要写在开头。

### 输出数据

在运行时，把元素的值或属性赋值给变量，此变量可以在之后的步骤中使用 `<>` 引用变量名。

| 操作  | 页面   | 元素   | 测试数据  | 输出数据   |
| --- | ------ | ------ | --------- | ---------- |
| 点击  | 百度搜索页面 | 搜索结果#1 |     | title=text |
| 检查  | 通用   | 页面标题 | `<title>` |    |

### 测试步骤

测试步骤为必填字段，否则视为无效步骤、不予执行。

控制语句：

- `if` `then` `else`

| 测试步骤  | 操作  | 页面  | 元素   | 测试数据 |
| ------- | --- | --- | ---------- | ---- |
| `^3`  | 检查  | 通用  | 页面标题   | \*知乎 |
| `>4`  | 点击  | 通用  | link#登录  |  |
| `<5` | 点击  | 通用  | link#注册机构号 |  |

`^` 表示 `if` 语句

`>` 表示 `then` 语句

`<` 表示 `else` 语句

`if`(`^`) 语句为真时，执行 `then`(`>`) 语句，为否时执行 `else`(`<`) 语句。无论后面有没有 `then` 或者 `else` 语句，不影响后续步骤执行。

`then` 语句或者 `else` 语句，当不被执行时，测试结果为 `-`，不影响测试用例结果和后续步骤执行。当执行时，和正常步骤一样，成功则继续，失败则该用例失败。

在`if`(`^`) 语句后，`then`(`>`) 或 `else`(`<`) 可以出现 0 次或多次，框架按步骤顺序进行判断执行。

## 进阶

### 等待时间

有些页面可能会加载比较慢，需要显式的指明等待时间，则直接在测试数据写上：`#wait_time=N`，指定在执行此步骤之前，先等待 `N` 秒，如下：

| 操作  | 页面   | 元素 | 测试数据     |
| --- | ------ | ---- | ---------------- |
| 检查  | 百度搜索页面 | 搜索按钮 | text=百度一下，`#wait_time=3` |

### 全局等待时间

如果需要所有步骤都有等待时间，在需要开始全局等待的步骤的测试数据中，写 `#wait_times=n`，如：

| 操作  | 页面   | 元素   | 测试数据     |
| --- | ------  | ------ | ---------------- |
| 检查  | 百度  | 搜索按钮 | text=测试，`#wait_times=3` |

如果想取消全局等待时间，在需要的步骤中写 `#wait_times=0`
设置了全局等待时间后，亦可在步骤设置 `#wait_time`，该步骤将按 `#wait_time` 来等待。

### 变量、运行时变量及测试数据文件

#### 1. 变量

在 操作(关键字)及对应的测试数据 -> 执行章节里我们讲的 `keyswords=搜狗` 就是变量赋值。

#### 2. 运行时变量

当某一变量是在测试执行时才能获取到，并在获取之后的步骤中才能使用的变量，我们叫运行时变量。在 `输出数据` 章节里的 `title=text` 就是运行时变量。

#### 3. 测试数据文件

有些测试用例中的值，在每次执行用例时都需要是唯一的，不能和之前使用过的重复。这时候我们就需要使用测试数据文件，如 `Baidu-baidu.csv`，如下表：

| `_keywords` | `_title`   | `flag` |
| ------------ | --------------- | ---- |
| segmentfault | SegmentFault 思否 | `Y`  |
| 豆瓣     | 豆瓣      |  |

测试数据文件中，第一行为变量名称，建议以下划线(`_`)开头，如 `_title`，以便和测试用例里定义的变量名称区分，但最后一个字段 `flag` 为是否使用标识(不能作为变量使用)。

当我们写测试用例时，就可以直接使用 `<_keywords>`, `<_title>` 这些变量。如测试用例:BAIDU_005

| 测试步骤 | 操作  | 页面   | 元素    | 测试数据       |
| ---- | --- | ------ | ----------- | ------------------------ |
| 1  | 执行  | 用例片段 | SNIPPET_001 | keywords=`<_keywords>` |
| 2  | 点击  | 百度搜索页面 | 搜索结果#1  |          |
| 3  | 检查  | 通用   | 页面title   | `<_title>`     |

当自动化运行时，会自动去查找对应的测试数据文件，如果有，则会顺序读取文件行，当读到某一行 `flag` 不为 `Y` 时，就把该行数据导入到变量列表里，同时把测试数据文件中的该行的 `flag` 列写入 `Y`。
需要注意的是，当测试数据文件中的所有行的 `flag` 都为 `Y` 时，就无数据导入了，测试用例执行就会失败。所以需要在测试数据文件中准备好足够多的数据行，或者及时维护添加数据。

测试数据文件支持唯一数据和通用数据混写

| `_date`  | `code`   | `flag` |
| -------- | -------- | ------ |
|          | 000001   |  N     |
|          | 000002   |  N     |
|          | 000003   |  N     |
|          | `&quot;` |  N     |
| 20101107 |          |        |
| 20101108 |          |        |
| 20101109 |          |        |
| 20101110 |          |        |

- flag 为 N 的行，是普通数据，每次执行都会读取
- flag 为空的行，是唯一数据行，每次只读取一行
- 单元格为空字符时，不会读取
- 如果想设置字段为空字符，应该写：`&quot;`，如上表第4行数据的 code 列的值

### frame 切换

如果有元素在 `iframe`/`frame` 中，则在元素定义表中，该元素需要定义 `custom` 的值，此值可以为 `id`/`name`/`index`/`WebElement`

1. `id` 或 `name` 直接写值即可
2. `index` 以 `#` 开头，如：`#1`。
3. `WebElement` 必须以变量定位法来定义，如 `id#su`，`xpath#//\*[@class="tabIframe"]`

> 注意，`index` 是从 `0` 开始，在嵌套的 `frame` 里，也是从 `0` 开始。

示例：

| page | element | by  | value | custom |
| ---- | ------- | --- | ----- | ------ |
| 通用 | 查询      | id  | su    | `#1`   |

如果是多层 frame,则 custom 中要以依次写上以‘|’分割的值，如：

| page | element | by  | value | custom |
| ---- | ------- | --- | ----- | ------ |
| 通用 | 查询      | id  | su    | `frame1|frame2`   |

### 用例组合

用例组合：即一组测试用例。`用例编号`中如果有 # 号则该用例属于用例组合，第一个 # 号前的字符串为组合名称

| 用例编号   | 用例标题  | 前置条件   | 测试步骤 |
| --------- | --------- | --------- | ------- |
| buy#find  | 查找      |           | 1       |
|           |           |           | 2       |
| buy#order | 下单      |           | 1       |
| buy#pay   | 支付      |           | 1       |

如上3个用例同属于用例组合 `buy`，那么我们可以用如下方式循环调用

| 用例编号   | 用例标题  | 前置条件  | 测试步骤 | 操作  | 页面      | 元素    | 测试数据 |
| --------- | -------- | --------- | ------- |-------| --------- | ------- | ---------|
| shopping  | 网购     |           | 1       | `执行` | `用例组合` | `buy`*2 | price=<_price>|

元素中的 `buy` 为用例组合名称

我们可以在测试数据中给变量赋值（和执行用例片段的赋值类似）

用例组合执行结果将按顺序添加在测试套件结果的结尾

> 注意：被标记为用例组合的用例默认不执行，只有通过如上的执行步骤才会执行

### 检查

在测试用例中，测试数据/预期结果的值默认都是 `str` 类型。
如果值是其他类型，需要写在 `<>` 中。

#### 值为 `int` 或者 `float`

如果为 `int` 或者 `float` 类型，需要写在 `<>` 中，例如：

| 操作 | 页面   | 元素       | 测试数据    |
| ---- | ------ | ---------- | ----------- |
| SQL  | Oracle | 查询User表 | ID=`<123456>` |

#### 值为 False 或则 True

| 操作  | 页面    | 元素     | 测试数据       |
| ----- | ------ | ------ | -------------- |
| POST  | ECHO | post请求 | verify=`<False>` |

#### 值为数值计算

| 操作  | 页面    | 元素     | 测试数据       |
| ----- | ------ | ------ | -------------- |
| POST  | ECHO | post请求 | sum=`<x+1>` |

#### 计算值转为 `str` 类型

| 操作  | 页面    | 元素     | 测试数据       |
| ----- | ------ | ------ | -------------- |
| POST  | ECHO | post请求 | sum=`<str(x+1)>` |

#### 值为函数调用

| 操作  | 页面    | 元素     | 测试数据       |
| ----- | ------ | ------ | -------------- |
| POST  | ECHO | post请求 | day=`<u.td(-3)>` |

#### 更多比较形式

|开头字符|匹配说明|示例    |示例说明    |
| ------ | ---------- | -------- | ------------ |
| `*`     | 包含       | *test    | 包含test     |
| `^`      | 开头       | ^hello   | 以hello开头  |
| `$`      | 结尾       | $world   | 以world结尾  |
| `\`      | 特殊符号转义 | \\*      | 匹配*        |
| `#`      | 不等于     | #test    | 不为test     |

#### 随机数

<> 运算中支持直接使用 random 库，如：指定范围的一个随机整数，写作

| 操作   | 页面    | 元素   | 测试数据 |
| ------ | ------ | ------ | ------- |
| `输入`  | 百度   | 搜索框 |   `<random.randint(1,10)>,,`  |

注意用双逗号分割。

详细使用方法可参见文章：https://www.cnblogs.com/skyEva/p/6097157.html

### 自定义 cookie

支持在`打开`操作中添加自定义 cookie

| 操作 | 页面 | 元素 | 测试数据 |
| --- | --- | --- | ---|
| 打开 | 通用|百度首页 | #tab_name=百度,,cookie={'domain':'.baidu.com', 'name': 'SWEETEST', 'value': '888888'}|

cookie 可以是通过自定义函数获取

| 操作 | 页面 | 元素 | 测试数据 |
| --- | --- | --- | ---|
| 打开 | 通用|百度首页 | #tab_name=百度,cookie=<c.get_cookie()>|

### 截屏及元素截图比较

在所有的 Web 操作步骤中，都可以进行截图输出和截图比较，其中截图动作是在本步骤操作完成之后进行。

#### 输出截图

在输出数据中，将截图赋值给变量，如下：

`#screen_shot`表示截屏，`home_png`为输出变量，保存了截图的路径。

| 操作 | 页面     | 元素      | 测试数据           |   输出数据            |
| ---- | ------- | -------- | ------------------ | --------------------  |
| 检查 | 百度搜索 | 页面title  | 百度一下，你就知道 | `home_png=#screen_shot` |

`#element_shot`表示元素截图，`search_png`为输出变量，保存了截图的路径。

| 操作  | 页面     | 元素    | 测试数据 | 输出数据                   |
| ----- | ------- | ------- | ---------| --------------------------|
| 点击  | 百度搜索 | 搜索按钮 |          | `search_png=#element_shot` |

> 注：可以在启动脚本中设置全局全屏截图，则每个 Web 操作步骤都会自动截屏保存。

#### 截图比较

在测试数据中，对截图进行比较。截图比较有2种模式：

##### 动态比较

将本步骤的截图和运行时前面步骤的输出截图进行比较，如下：

`#screen_shot`表示本步骤操作完成后的截屏，`<home_png>` 为前面步骤输出的截图。

| 操作 | 页面     | 元素      | 测试数据                                    | 
| ---- | ------- | -------- | -------------------------------------------- | 
| 检查 | 百度搜索 | 页面title  | 百度一下，你就知道, `#screen_shot=<home_png>` | 

`#element_shot`表示本步骤操作完成后的元素截图，`<search_png>`为前面步骤输出的截图。

| 操作  | 页面     | 元素    | 测试数据 | 输出数据                   |
| ----- | ------- | ------- | ---------| --------------------------|
| 点击  | 百度搜索 | 搜索按钮 |          | `search_png=<search_png>` |

##### 静态比较

将本步骤的截图和预先保存的预期截图比较，如下：

`#screen_shot`表示本步骤操作完成后的截屏，`home.png` 为预期的截图文件名。

| 操作 | 页面     | 元素      | 测试数据                                    | 
| ---- | ------- | -------- | -------------------------------------------- | 
| 检查 | 百度搜索 | 页面title  | 百度一下，你就知道, `#screen_shot=home.png` | 

`#element_shot`表示本步骤操作完成后的元素截图，`button.png`为预期的截图文件名。

| 操作  | 页面     | 元素    | 测试数据                  | 
| ----- | ------- | ------- | -------------------------| 
| 点击  | 百度搜索 | 搜索按钮 | `#element_shot=button.png`|

##### 按坐标涂白和剪切

- 测试数据中，有 `#blank` 时，涂白对应的区域，其中 () 中的坐标为 ( left, upper, right, lower)
- 测试数据中，有 `#cut` 时，截取对应区域
- 同时有 `#blank` 和 `#cut` 时，先涂白后截图

| 操作  | 页面     | 元素    | 测试数据 |
| ----- | ------- | ------- | ---------|
| 点击  | 百度     | 搜索按钮 | `#element_shot=button.png,, #blank=[(30,10,60,25),(65,10,70,25)],, #cut=(15,7,80,25)` |

几点说明：

- 预期的截图文件名必须以 .png 结尾
- 预先保存的预期截图必须放在 `snapshot\expected\<plan_name>` 目录
- 但实际上我们不需要手动去截图保存，框架已经自动识别是否有预期截图存在，如果不存在，则本次运行把截图保存为预期图片，且不做比较
- 当再次运行时，预期图片已经有了，就会真正的比较

> 注：在 Chrome/Firefox 正常模式下，全屏截图和元素截图只能截取屏幕可见部分；如果想截取整个（含不可见部分）页面/元素，需要使用 IE 或者 Chrome/Firefox 的 headless 模式

### 元素管理

测试用例中元素是以 `page + element` 为唯一标识，来页面元素表中查找定位信息的。因此，不同 `page` 下的元素 `element` 可以相同，但不能和 `通用` 下的相同。

测试用例中，如果 `page` 不为 `通用`，当 `page + element` 查找不到，会继续以 `通用 + element` 为标识符来查找。

### 自定义函数

自定义函数在生成示例目录的 `lib` 下面。

#### 定义

在 `lib/c.py` 或 `lib/u.py` 中添加自己定义的函数。也可以自己创建 `.py` 文件，但需要添加文件名到在 `lib/__init__.py` 中。

`lib/http_handle.py` 是 `Http` 测试的预处理文件(注：此文件和其中的函数不可以删除或修改名称)。

使用场景如：接口需要签名加密处理，则可以在此函数中自定义。

#### 调用

在测试用例的测试数据/预期结果中，可以使用类似 `<c.today()>` 方式来调用。

- 支持传参，如：`<u.td(t=1)>` 或者 `<u.td(1)>`

- 如果参数是字符，需要带引号，如：`<u.td(t='1')>` 或者 `<u.td('1')>`

- 如果参数是已有变量，直接写即可，如，已知 t=3，写法为：`<u.td(t=t)>` 或 `<u.td(t)>`

- 如果有多个参数，写法为：`<u.td(t=t, d=d)>`, 但分隔符应该为双逗号(`,,`)，如：

| 操作  | 页面     | 元素    | 测试数据                  | 
| ----- | ------- | ------- | -------------------------| 
| 检查  | 交易页面 | 日期    | `text=<u.td(t=t, d=d)>,,`|

#### 返回结果

自定义函数可以返回 `str`, `int`, `float` 等简单类型，但需要注意，如果在 `<>` 之外还有其他字符，则返回值会被处理为 `str`。

如:`age=<c.age()>岁`，假设 `c.age()` 函数返回的是数字 `18`，因为 `<>` 后面还有字符，那么 `18` 会被处理成字符串，再和 `岁` 字拼接，即 age 的实际值为字符串 `18岁`。

#### 左侧函数

在检查关键字中，我们可以使用左侧入参函数功能（简称：左侧函数）

| 操作  | 页面   | 元素  | 测试数据    |
| ----- | ----- | ----- | ---------- |
| 检查  |  首页 |  金额  |  text=`:f(v, 100),,` |

如上表，冒号(:)开头表示后面为左侧函数，f 为函数名，v 表示等号(=)左侧的值(text)，100 是其他参数(可以为变量，如`<p>`)。

注意:

- 用例里 f 的第一个参数一定要是 v
- 以双逗号(,,)分割

##### 内置左侧函数 f

f 用来比较数值。

如：实际值 text='1,234.567'，预期值：p=1234.57，当浮点精度为2时，测试数据写作：`text=:f(v, <p>, 2)`，结果为通过

如果预期值：p='1,234.57'，为字符串，则 <p> 需要带引号：`text=:f(v, '<p>', 2)`

当浮点精度为3时，测试数据写作：`text=:f(v, <p>, 3)`，结果为失败

如果要比较整形，可以写作：`text=:f(v, <p>, 0)`

##### 自定义左侧函数

当需要自定义左侧函数时，请在 c.py 或 u.py 中定义，测试用例中，应该写作：text=`:c.myfunc(v, 'foo')`

### 浏览器标签页管理

在浏览器中，有可能会打开多个标签页，当你新`打开`或者`点击`弹出一个新标签页时，你可以在测试数据中给它起个名字，格式为：#tab_name=<window_name>, 如：

| 操作  | 页面   | 元素   | 测试数据    |
| --- | ------ | ------ | ----------- |
| 打开  | 通用   | 百度网址 | #tab_name=百度 |
| 检查  | 首页 | 页面标题 | 百度一下，你就知道 |

当你给新标签页起了名字，它之后步骤的页面("通用"除外)就会绑定到这个标签页。如上面第 2 步，“首页”会绑定到“百度”这个标签页。

那么之后的步骤或用例中，即使打开了多个标签页，只要页面是“首页”，就会切换到“百度”这个标签页上去操作。

注意：“通用”是不绑定到任何窗口的，也不做标签页切换，它直接在`当前标签页`操作。

`当前标签页`规则为：

- 执行到某个步骤时，`当前标签页`是浏览器焦点所在的窗口，也就是上个步骤执行操作的标签页。
- 如果此步骤的页面已绑定到其他标签页（假设为A），则首先切换到A标签页操作，而`当前标签页`也会随之变为A。
- 如果此步骤的页面尚未捆定任何窗口，则会捆定到`当前标签页`。
- 上个步骤如果是新打开的窗口，则`当前标签页`是新打开的窗口。

注意：

- 如果打开了 2 个或以上标签页，没有起名字的标签页，会在执行切换到其他标签页时自动被关掉。
- 起了名字的标签页不会被关掉。
- 但如果起了同样的名字，则原先的那个标签页会被关掉，绑定在其上面的页面也会被注销。

## Http 接口测试

### 基本参数定义

接口服务的基本参数需要定义在 Elements.xlsx 里，可参见示例：Echo-Elements.xlsx

|page|element     |by  |value                                                |
|----|------------|----|-----------------------------------------------------|
|Echo|baseurl     |    |https://postman-echo.com/                            |
|    |headers_get |    |{'Content-Type': 'application/x-www-form-urlencoded'}|
|    |headers_post|    |{'Content-Type': 'application/json'}                 |
|    |get请求       |    |/get                                                 |
|    |post请求      |    |/post                                                |

其中，headers_get 是默认的 get 请求头，headers_post 是默认的 post 请求头。如果用例的测试数据里也写了 headers，会用该 headers 更新请求头。

### 用例写法

用例写法见示例：Echo-TestCase.xlsx。

### 测试数据

需要注意的是，测试数据里，params, data, json, files 的用法：

- params：GET 请求的参数
- json： POST 请求头中 Content-Type 为application/json 时使用的参数，值必须为 json 或字典(dict)格式
- data: POST 请求除 json 以外格式的参数；或者 PUT, PATCH 的参数。
- files：上传文件的参数。

### 预期结果

注意！在 Http 接口测试用例中，预期结果必须写在预期结果列（不能像 Web UI 测试中预期结果可以写在测试数据列）。

预期结果支持检查以下字段：status_code, text, json, cookies, headers。

其中，json, cookies, headers 是 json 格式，检查方法使用的是 injson 库，详情见：[injson 项目](https://github.com/tonglei100/injson)

#### 检查响应时间

在预期结果中写 `time=1`，表示预期响应时间小于1秒。

| 操作 | 页面    | 元素     |  测试数据                               |  预期结果                |
| ---  | ------ | -------- | -------------------------------------- | ----------------------- |
| GET  | Echo   | get请求  | params={'foo1': 'bar1', 'foo2': 'bar2'},, | status_code=200,,`time=1` |

## 文件及命令行

文件操作是通过调用系统的命令行来实现的，如 Windows 上拷贝文件 `copy doc\test.txt back\`，支持通配符，如 `copy doc\*.txt back\`，文件操作同时支持 Windows 和 linux 或 Mac，框架已做了适配。

### 文件操作

#### 拷贝(COPY)

在测试主机上拷贝文件，支持共享目录的拷贝。

- 页面是要切换到的工作目录，可不填，默认是自动化测试目录
- 元素是被拷贝的文件或目录，支持通配符
- 测试数据是目的文件或目录

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| COPY | D:\code | log.txt  | log        |

#### 移动(MOVE)

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| MOVE | D:\code | log.txt  | log        |

#### 删除文件(REMOVE)

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| REMOVE | D:\code | log.txt  |         |

#### 删除目录(RMDIR)

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| RMDIR | D:\code | log    |             |

#### 创建目录(MKDIR)

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| MKDIR | D:\code | log    |             |

### 文件或文件夹判断

#### 路径存在(EXISTS)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| EXISTS | D:\code | log    |            |

#### 路径不存在(NOT_EXISTS)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| NOT_EXISTS | D:\code | xoxo    |       |

#### 是文件(IS_FILE)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| IS_FILE | D:\code | log.txt    |       |

#### 不是文件(NOT_FILE)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| NOT_FILE | D:\code | log  |            |

#### 是目录(IS_DIR)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| IS_DIR | D:\code | log    |            |

#### 不是目录(NOT_DIR)

测试文件或文件夹路径是否存在

| 操作 | 页面     | 元素      | 测试数据   |
| ---- | ------- | -------- | ---------- |
| NOT_DIR | D:\code | log.txt    |       |

### 命令行

命令行是调用系统命令行实现的，根据返回值判断是否成功。

#### COMMAND

不判断操作系统类型，直接执行

| 操作    | 页面     | 元素               | 测试数据   |
| ------- | ------- | ------------------ | --------- |
| COMMAND | D:\code | python start.py    |           |

#### SHELL

只有当系统是 Linux 和 Mac 时才执行；Windows 时直接跳过，结果为成功。

| 操作    | 页面     | 元素               | 测试数据   |
| ------- | ------- | ------------------ | --------- |
| SHELL | D:\code | python start.py    |             |

#### CMD

只有当系统是 Windows 时才执行；Linux 和 Mac 时直接跳过，结果为成功。

| 操作    | 页面     | 元素               | 测试数据   |
| ------- | ------- | ------------------ | --------- |
| CMD | D:\code | python start.py    |               |

### 输出数据

提取字段值，同样使用的是 injson 库。

# 测试执行

```python
python start.py
```

- 按条件筛选用例执行

在启动脚本(start.py)里配置：

```python
# 按条件执行,支持筛选的属性有：'id', 'title', 'designer', 'priority'
sweet.fliter(priority='H')
# or
sweet.fliter(priority=['H', 'L'])
```

- headless 模式

在启动脚本里的 desired_caps 中，增加 `'headless': True`

```python
desired_caps = {'platformName': 'Desktop', 'browserName': 'Chrome', 'headless': True}
```

- 全局截屏模式

在启动脚本里的 desired_caps 中，增加 `'snapshot': True`

```python
desired_caps = {'platformName': 'Desktop', 'browserName': 'Chrome', 'snapshot': True}
```

配置全局截屏模式以后，所有 Web 的操作步骤都会自动截屏，保存在 snapshot 相应目录

## 测试报告

### Excel 格式

见 report 目录

### Junit 格式

见 Junit 目录

### Web 版

[Web 版测试报告使用说明](/sweetest/report)

## 测试报告详细数据

见启动脚本，其中 sweet.report_data 为测试报告详细数据

```python
# 测试报告详细数据，可以自行处理后写入其他测试报告系统
print(sweet.report_data)
```
